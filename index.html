<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360° Panorama Viewer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 20px;
            font-size: 18px;
            background-color: #008cba;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button id="startButton">Enable Motion</button>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js';

        let scene, camera, renderer;
        let initialAlpha = 0, initialBeta = 0, initialGamma = 0;
        let isCalibrated = false;

        function init() {
            // Szene erstellen
            scene = new THREE.Scene();

            // Kamera erstellen
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0.1);

            // Renderer erstellen
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // 360° Bild laden
            const textureLoader = new THREE.TextureLoader();
            const texture = textureLoader.load('test.jpg', () => {
                console.log('Texture loaded successfully!');
            });

            // Kugel-Geometrie erstellen
            const geometry = new THREE.SphereGeometry(500, 128, 128); // Höhere Segmente für bessere Darstellung
            geometry.scale(-1, 1, 1);

            const material = new THREE.MeshBasicMaterial({ map: texture });
            const sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);

            // Bewegungssensor-Daten verwenden
            window.addEventListener('deviceorientation', (event) => {
                if (!isCalibrated) {
                    // Initialwerte als Referenz für Kalibrierung speichern
                    initialAlpha = event.alpha || 0;
                    initialBeta = event.beta || 0;
                    initialGamma = event.gamma || 0;
                    isCalibrated = true;
                }

                // Werte relativ zur Kalibrierung berechnen
                const yaw = THREE.MathUtils.degToRad((event.alpha || 0) - initialAlpha); // Links/Rechts drehen
                const pitch = THREE.MathUtils.degToRad((event.beta || 0) - initialBeta); // Hoch/Runter schauen
                const roll = THREE.MathUtils.degToRad((event.gamma || 0) - initialGamma); // Neigung

                // Pitch begrenzen, um unnatürliche Werte zu vermeiden
                const clampedPitch = Math.max(Math.min(pitch, Math.PI / 2), -Math.PI / 2); // Begrenzung auf ±90°

                // Debugging: Rotation prüfen
                console.log(`Pitch: ${clampedPitch}, Yaw: ${yaw}, Roll: ${roll}`);

                // Kamerarotation setzen
                camera.rotation.set(clampedPitch, yaw, -roll);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        document.getElementById('startButton').addEventListener('click', () => {
            // Berechtigung anfordern (nur für iOS und moderne Browser erforderlich)
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then((permissionState) => {
                        if (permissionState === 'granted') {
                            init();
                            animate();
                            document.getElementById('startButton').style.display = 'none';
                        } else {
                            alert('Permission denied for motion sensors.');
                        }
                    })
                    .catch(console.error);
            } else {
                // Für Browser, die keine Berechtigung anfordern
                init();
                animate();
                document.getElementById('startButton').style.display = 'none';
            }
        });
    </script>
</body>
</html>
